version: 2.1
description: Yarn commands

orbs:
  node: circleci/node@0.0.7

commands:
  install:
    description: "yarn install"
    parameters:
      yarn-version:
        type: string
        description: Version of yarn to use.
        default: 1.13.0
      cache-version:
        type: string
        description: Cache version; increment this for a fresh cache.
        default: v1
      save-cache:
        type: boolean
        description: Set to false to save cache on your own. Useful for monorepos.
        default: true

    steps:
      - node/install-package-manager:
          yarn: true
          yarn_version: << parameters.yarn-version >>
      - restore_cache:
          name: "Restore node_modules Cache"
          keys:
            - yarnpkg-<< parameters.cache-version >>-{{ arch }}-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - yarnpkg-<< parameters.cache-version >>-{{ arch }}-{{ .Branch }}-
            - yarnpkg-<< parameters.cache-version >>-{{ arch }}-
      - run:
          name: "Run yarn install"
          command: |
            yarn --frozen-lockfile
      - when:
          condition: << parameters.save-cache >>
          steps:
            - save_cache:
                name: "Save node_modules Cache"
                key: yarnpkg-<< parameters.cache-version >>-{{ arch }}-{{ .Branch }}-{{ checksum "yarn.lock" }}
                paths:
                  - ~/.cache/yarn
                  - ~/project/node_modules
